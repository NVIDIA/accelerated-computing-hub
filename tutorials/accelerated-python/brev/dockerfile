FROM ghcr.io/nvidia/mirrors/rapidsai-devcontainers-25.08-cpp-cuda12.8

ENV PIP_ROOT_USER_ACTION=ignore \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    VIRTUAL_ENV_DISABLE_PROMPT=1 \
    ACH_RAPIDS_VENV=/opt/venvs/rapids \
    ACH_TUTORIAL=accelerated-python \
    BASH_ENV=/accelerated-computing-hub/brev/user-env.bash

# Install system packages (needed before pip install for git-based packages)
RUN apt-get update -y \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git \
    git-lfs \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    sudo \
 && apt-get clean -y \
 && rm -rf /var/lib/apt/lists/*

# Create ach user with passwordless sudo
RUN groupadd --gid 1000 ach \
 && useradd --uid 1000 --gid 1000 --create-home --shell /bin/bash ach \
 && echo 'ALL ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers \
 && usermod -aG sudo ach

# Install Docker
RUN mkdir -p /etc/apt/keyrings \
 && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
 && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
 && apt-get update -y \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    docker-buildx-plugin \
    docker-compose-plugin \
 && apt-get clean -y \
 && rm -rf /var/lib/apt/lists/* \
 && usermod -aG docker ach

# Copy only requirements.txt first for better Docker layer caching.
COPY tutorials/${ACH_TUTORIAL}/brev/requirements.txt /opt/requirements.txt

# Remove externally managed flag and install Python packages.
RUN rm -f /usr/lib/python3.*/EXTERNALLY-MANAGED \
 && pip install --no-cache-dir --root-user-action=ignore -r /opt/requirements.txt \
 && rm -f /opt/requirements.txt

# Install MPI.
RUN apt-get update -y \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    openmpi-bin \
    libopenmpi-dev \
 && apt-get clean -y \
 && rm -rf /var/lib/apt/lists/*

# Install Nsight Systems and Nsight Compute.
RUN curl -L -O https://developer.nvidia.com/downloads/assets/tools/secure/nsight-systems/2025_3/NsightSystems-linux-cli-public-2025.3.1.90-3582212.deb \
 && dpkg -i NsightSystems-linux-cli-public-2025.3.1.90-3582212.deb \
 && rm -f NsightSystems-linux-cli-public-2025.3.1.90-3582212.deb \
 && curl -L -O https://developer.download.nvidia.com/compute/cuda/repos/debian12/x86_64/nsight-compute-2025.2.1_2025.2.1.3-1_amd64.deb \
 && dpkg -i nsight-compute-2025.2.1_2025.2.1.3-1_amd64.deb \
 && rm -f nsight-compute-2025.2.1_2025.2.1.3-1_amd64.deb \
 && mkdir -p /usr/local/nvidia/bin \
 && ln -s /opt/nvidia/nsight-systems-cli/2025.3.1/bin/nsys /usr/local/nvidia/bin/nsys \
 && ln -s /opt/nvidia/nsight-compute/2025.2.1/ncu /usr/local/nvidia/bin/ncu

# Install PyTorch with CUDA 12.8 support.
RUN pip install --no-cache-dir --root-user-action=ignore \
    --index-url https://download.pytorch.org/whl/cu128 \
    torch

# Disable Jupyter announcements extension
RUN python -m jupyter labextension disable "@jupyterlab/apputils-extension:announcements"

# Create an isolated Python env with cuDF and cuML, and register it as a Jupyter kernel.
RUN python -m venv ${ACH_RAPIDS_VENV} \
 && ${ACH_RAPIDS_VENV}/bin/pip install --no-cache-dir \
    --extra-index-url=https://pypi.nvidia.com \
    "cudf-cu12==25.10.*" \
    "cuml-cu12==25.10.*" \
    ipykernel \
    pytest \
 && ${ACH_RAPIDS_VENV}/bin/python -m ipykernel install \
    --name=cudf-cu12-25.10 \
    --display-name="Python 3 (RAPIDS 25.10)" \
    --prefix=/usr/local

COPY . /accelerated-computing-hub

# Ensure accelerated-computing-hub directory is writable by any user and setup shell initialization
RUN chmod -R a+rwX /accelerated-computing-hub \
 && mkdir -p /accelerated-computing-hub/logs \
 && chmod 777 /accelerated-computing-hub/logs \
 && ln -s /accelerated-computing-hub/brev/user-env.bash /etc/profile.d/ach-user-setup.sh \
 && echo 'source /accelerated-computing-hub/brev/user-env.bash' >> /etc/bash.bashrc

WORKDIR /accelerated-computing-hub/tutorials/${ACH_TUTORIAL}/notebooks

# Set default user to ach (can be overridden with docker run --user)
USER ach

ENTRYPOINT ["/accelerated-computing-hub/brev/jupyter-start.bash"]
