FROM rapidsai/devcontainers:25.10-cpp-cuda12.9

ARG GIT_BRANCH_NAME
ENV GIT_BRANCH_NAME=${GIT_BRANCH_NAME}

COPY . /accelerated-computing-hub

COPY brev/update-git-branch.bash /update-git-branch.bash

WORKDIR /accelerated-computing-hub/gpu-python-tutorial/notebooks

ENV PIP_ROOT_USER_ACTION=ignore

RUN pip install --root-user-action ignore -r /accelerated-computing-hub/gpu-python-tutorial/brev/requirements.txt \
 && git config --unset-all "http.https://github.com/.extraheader" || { code=$?; [ "$code" = 5 ] || exit "$code"; } \
 && git config --global --add safe.directory "/accelerated-computing-hub" \
 && mkdir -p ~/.local/state/._bash_history \
 && mkdir -p ~/.jupyter \
 && ln -fs /accelerated-computing-hub/brev/jupyter-server-config.py ~/.jupyter/jupyter_server_config.py \
 && mkdir -p ~/.ipython/profile_default/startup \
 && ln -fs /accelerated-computing-hub/brev/ipython-startup-add-cwd-to-path.py ~/.ipython/profile_default/startup/00-add-cwd-to-path.py \
 && python -m jupyter labextension disable "@jupyterlab/apputils-extension:announcements"

# ---------- cuDF venv & kernel (non-default) ----------
# Create an isolated Python env with cuDF, and register it as a Jupyter kernel
ENV CUDF_VENV=/opt/venvs/cudf
RUN python -m venv ${CUDF_VENV} \
 && ${CUDF_VENV}/bin/python -m pip install --upgrade pip \
 && ${CUDF_VENV}/bin/pip install \
      --extra-index-url=https://pypi.nvidia.com \
      "cudf-cu12==25.8.*" \
      ipykernel \
 && ${CUDF_VENV}/bin/python -m ipykernel install \
      --name=cudf-cu12-25.8 \
      --display-name="Python (cuDF 25.8)" \
      --prefix=/usr/local

 CMD ["/accelerated-computing-hub/brev/jupyter-start.bash"]
